import{r as i,a,j as e,F as J}from"./jsx-runtime-7cf68bf7.js";import{u as R,h as P,f as I,L as l,q as X,a0 as G,M as z,a5 as Q,C as k,J as Z,b as H,Y as K,Q as ee,a6 as $,$ as te,a7 as ae,a8 as se,o as C,U as ie,a9 as le,N as ne,aa as ce}from"./Phone-ec5c0d3e.js";function re(){const{Email:M,View:S,Mails:p,SelectedMail:u,ShowNewMail:w,LoggedIn:N,fetchAndSetMail:o}=i.useContext(O),v=R(H.Settings),[s,d]=M,[m,t]=p,[h,r]=S,[c,L]=w,[A,E]=N,[g,b]=i.useState(""),[V,W]=i.useState(""),[_,T]=i.useState([]),[U,j]=i.useState(0),[q,y]=i.useState(!1),[B,D]=i.useState(!1);i.useEffect(()=>{if(P.APPS.MAIL.recentmails.value)return t(P.APPS.MAIL.recentmails.value);I("Mail",{action:"getMails",page:0}).then(n=>{n&&(t(n),P.APPS.MAIL.recentmails.set(n))})},[]),i.useEffect(()=>{const n=setTimeout(()=>b(V),500);return()=>clearTimeout(n)},[V]),i.useEffect(()=>{g.length>0?I("Mail",{action:"search",query:g,page:0}).then(n=>{n&&T(n)}):(T([]),j(0))},[g]);const Y=n=>{if(B||q)return;let x=document.querySelector("#last");if(!x)return;!K(x)&&(g.length>0?(y(!0),I("Mail",{action:"search",query:g,page:U+1}).then(f=>{f&&f.length>0?(T([...m,..._]),y(!1)):D(!0)}),j(f=>f+1)):(y(!0),I("Mail",{action:"getMails",page:U+1}).then(f=>{f&&f.length>0?(t([...m,...f]),y(!1),f.length<10&&D(!0)):D(!0)}),j(f=>f+1)))};return a("div",{className:"slide right",children:[e("div",{className:"mail-header",children:e("div",{className:"title",children:l("APPS.MAIL.TITLE")})}),e(X,{placeholder:l("SEARCH"),onChange:n=>W(n.target.value)}),e("div",{className:"mail-list",onScroll:Y,children:(g.length>0?_:m).map((n,x)=>{let F=x===m.length-1?"last":"";return a("div",{id:F,className:"mail",onClick:()=>o(n),children:[a("div",{className:"item-header",children:[a("div",{className:"user",children:[e("div",{className:"symbol","data-read":(n.read||n.sender===s)??!1}),e("div",{className:"sender",children:n.sender===s?a(J,{children:[l("APPS.MAIL.YOU"),a("span",{children:["- ",n.to]})]}):n.sender})]}),a("div",{className:"date",children:[e("div",{className:"time",children:G(n.timestamp,v.time.twelveHourClock)}),e(z,{})]})]}),a("div",{className:"item-body",children:[e("div",{className:"subject",children:n.subject}),e("div",{className:"message",children:n.message.length>70?n.message.substring(0,70)+"...":n.message})]})]},x)})}),e("div",{className:"mail-footer",children:a("div",{className:"footer-wrapper",children:[e(Q,{onClick:()=>{k.PopUp.set({title:l("APPS.MAIL.SIGN_OUT_POPUP.TITLE"),description:l("APPS.MAIL.SIGN_OUT_POPUP.DESCRIPTION"),buttons:[{title:l("APPS.MAIL.SIGN_OUT_POPUP.CANCEL")},{title:l("APPS.MAIL.SIGN_OUT_POPUP.PROCEED"),color:"red",cb:()=>{I("Mail",{action:"logout"}).then(n=>{n!=null&&n.success&&(r("login"),E(!1),d(null),P.APPS.MAIL.address.reset())})}}]})}}),a("div",{className:"text",children:[e("div",{className:"title",children:l("APPS.MAIL.UPDATED_NOW")}),a("div",{className:"count",children:[m.filter(n=>!n.read&&s!==n.sender).length," ",l("APPS.MAIL.UNREAD")]})]}),e(Z,{onClick:()=>L(!0)})]})})]})}function oe(){const{Email:M,View:S,SelectedMail:p,ShowNewMail:u}=i.useContext(O),w=R(H.Settings),[N,o]=S,[v]=M,[s]=p,[d,m]=u,t=i.useRef(null);return i.useEffect(()=>{t.current.style.height=t.current.scrollHeight+"px"},[t]),a("div",{className:"slide left",children:[e("div",{className:"mail-header",children:a("div",{className:"left",onClick:()=>o("home"),children:[e(ee,{}),l("APPS.MAIL.INBOX")]})}),a("div",{className:"mail-wrapper",children:[a("div",{className:"item-header",children:[a("div",{className:"user",children:[e("div",{className:"name",children:s.sender}),a("div",{className:"to",children:[a("span",{children:[l("APPS.MAIL.TO"),":"]})," ",s.to]})]}),e("div",{className:"date",children:G(s.timestamp,w.time.twelveHourClock)})]}),e("div",{className:"item subject",children:s.subject}),e("div",{className:"item message",children:e($,{value:s.message,disabled:!0,ref:t})}),s.attachments&&s.attachments.length>0&&e("div",{className:"item attachments",children:s.attachments.map((h,r)=>e("div",{className:"attachment",onClick:()=>{k.FullscreenImage.set({display:!0,image:h})},children:e(te,{src:h})},r))}),s.actions&&e("div",{className:"item actions",children:s.actions.map((h,r)=>e("div",{className:"action",onClick:()=>{I("Mail",{action:"action",id:s.id,data:h.data})},children:h.label}))})]}),e("div",{className:"mail-footer",children:a("div",{className:"footer-wrapper",children:[e("span",{}),e(ae,{onClick:()=>{m({to:s.sender===v?s.to:s.sender,subject:`Re: ${s.subject}`})}})]})})]})}function de(){const{Email:M,Mails:S,ShowNewMail:p}=i.useContext(O),[u]=M,[w,N]=S,[o,v]=p,s=i.useRef(null),[d,m]=i.useState(!1),[t,h]=i.useState({to:"",subject:"",message:"",attachments:[]});i.useEffect(()=>{typeof o=="object"&&h({...t,to:o.to,subject:o.subject})},[o]);const r=()=>{d&&(t.to===""||t.subject===""||t.message===""||I("Mail",{action:"sendMail",data:t}).then(c=>{if(!c)return;let L={...t,id:c,read:!0,sender:u,timestamp:Date.now()};if(N([L,...w]),!P.APPS.MAIL.recentmails.value)return;let A=P.APPS.MAIL.recentmails.value;A.length>=10&&A.pop(),A.unshift(L),P.APPS.MAIL.recentmails.set(A),v(!1)}))};return i.useEffect(()=>{const c=t.to.match(/^([\w.%+-]+)@([\w-]+\.)+([\w]{2,})$/i);t.to!==""&&c&&t.subject!==""&&t.message!==""&&u!==t.to?m(!0):m(!1)},[t]),a(se.div,{className:"new-mail-container",initial:{opacity:0,y:"100%"},animate:{opacity:1,y:0},exit:{opacity:0,y:"100%"},transition:{duration:.3,ease:"easeInOut"},children:[a("div",{className:"mail-header",children:[e("div",{className:"cancel",onClick:()=>v(!1),children:l("APPS.MAIL.CANCEL")}),e("div",{className:"title",children:l("APPS.MAIL.NEW_MESSAGE")}),e("div",{className:"send","data-disabled":!d,onClick:()=>r(),children:l("APPS.MAIL.SEND")})]}),a("div",{className:"mail-options",children:[a("div",{className:"option",children:[a("div",{className:"title",children:[l("APPS.MAIL.TO"),":"]}),e(C,{className:"blue",maxLength:60,defaultValue:t.to,onChange:c=>{h({...t,to:c.target.value})}})]}),a("div",{className:"option",children:[a("div",{className:"title",children:[l("APPS.MAIL.FROM"),":"]}),e(C,{type:"text",value:u,disabled:!0})]}),a("div",{className:"option",children:[a("div",{className:"title",children:[l("APPS.MAIL.SUBJECT"),":"]}),e(C,{type:"text",maxLength:50,defaultValue:t.subject,onChange:c=>{h({...t,subject:c.target.value})}})]}),a("div",{className:"option textarea",children:[a("div",{className:"title",children:[l("APPS.MAIL.MESSAGE"),":"]}),e($,{type:"text",ref:s,onChange:c=>{s.current.style.height="auto",s.current.style.height=s.current.scrollHeight+"px",h({...t,message:c.target.value})}}),e("div",{className:"attachments",children:t.attachments.map((c,L)=>a("div",{className:"attachment",children:[e("img",{src:c,onClick:()=>{k.FullscreenImage.set({display:!0,image:c})}},L),e(ie,{onClick:A=>{A.stopPropagation();const E=t.attachments;E.splice(L,1),h({...t,attachments:E})}})]},L))})]})]}),e("div",{className:"mail-footer",children:e("div",{className:"footer-wrapper",children:e(le,{onClick:()=>{k.Gallery.set({onSelect:c=>h({...t,attachments:[...t.attachments,c.src]})})}})})})]})}function me(){var h;const{Email:M,View:S}=i.useContext(O),[p,u]=M,[w,N]=S,o=R(ne),[v,s]=i.useState(null),[d,m]=i.useState({email:"",password:""}),t=()=>{d.email===""||d.password===""||I("Mail",{action:"createMail",data:d}).then(r=>{if(r&&r.success){const c=`${d.email}@${o.EmailDomain}`;u(c),P.APPS.MAIL.address.set(c),N("home")}else if(r&&r.error)return s(r.error)})};return a("div",{className:"mail-form",children:[a("div",{className:"item",children:[e("div",{className:"title",children:l("APPS.MAIL.EMAIL")}),a("div",{className:"input",children:[e(C,{type:"text",placeholder:"email",maxLength:50-((h=o.EmailDomain)==null?void 0:h.length),onChange:r=>{r.target.value.match(/^[a-zA-Z0-9]+$/)&&m({...d,email:r.target.value})}}),a("div",{className:"suffix",children:["@",o.EmailDomain]})]}),v==="Address already exists"&&e("div",{className:"error",children:l("APPS.MAIL.EMAIL_EXISTS")})]}),a("div",{className:"item",children:[e("div",{className:"title",children:l("APPS.MAIL.PASSWORD")}),e("div",{className:"input",children:e(C,{type:"password",placeholder:"********",onChange:r=>{m({...d,password:r.target.value})}})})]}),e("div",{className:"button",onClick:()=>t(),children:l("APPS.MAIL.CREATE_MAIL")}),a("div",{className:"footer",children:[l("APPS.MAIL.ALREADY_HAVE")," ",e("span",{onClick:()=>N("login"),children:l("APPS.MAIL.LOGIN")})]})]})}function he(){const{Email:M,View:S}=i.useContext(O),[p,u]=M,[w,N]=S,[o,v]=i.useState(null),[s,d]=i.useState({email:"",password:""}),m=()=>{v(null),I("Mail",{action:"login",data:s}).then(t=>{if(t&&t.success)u(s.email),P.APPS.MAIL.address.set(s.email),N("home");else if(t&&t.error)return v(t.error)})};return a("div",{className:"mail-form",children:[a("div",{className:"item",children:[e("div",{className:"title",children:l("APPS.MAIL.EMAIL")}),e("div",{className:"input",children:e(C,{type:"text",placeholder:"mail@domain.com",maxLength:50,onChange:t=>{d({...s,email:t.target.value})}})}),o==="Invalid address"&&e("div",{className:"error",children:l("APPS.MAIL.EMAIL_INVALID")})]}),a("div",{className:"item",children:[e("div",{className:"title",children:l("APPS.MAIL.PASSWORD")}),e("div",{className:"input",children:e(C,{type:"password",placeholder:"********",onChange:t=>{d({...s,password:t.target.value})}})}),o==="Invalid password"&&e("div",{className:"error",children:l("APPS.MAIL.WRONG_PASSWORD")})]}),e("div",{className:"button",onClick:()=>m(),children:l("APPS.MAIL.LOGIN")}),a("div",{className:"footer",children:[l("APPS.MAIL.NO_EMAIL")," ",e("span",{onClick:()=>N("signup"),children:l("APPS.MAIL.CREATE_ONE")})]})]})}const O=i.createContext(null);function ve(){const[M,S]=i.useState(null),[p,u]=i.useState("signup"),[w,N]=i.useState([]),[o,v]=i.useState(null),[s,d]=i.useState(!1),[m,t]=i.useState(!1),[h,r]=i.useState(!0),c=A=>{A&&I("Mail",{action:"getMail",id:A.id}).then(E=>{if(!E)return;v(E),u("mail");let g=P.APPS.MAIL.recentmails.value;g=g==null?void 0:g.map(b=>(b.id===A.id&&(b.read=!0),b)),P.APPS.MAIL.recentmails.set(g)})},L={home:e(re,{}),mail:e(oe,{}),signup:e(me,{}),login:e(he,{})};return i.useEffect(()=>{if(P.APPS.MAIL.address.value){S(P.APPS.MAIL.address.value),r(!1),u("home");return}I("Mail",{action:"isLoggedIn"}).then(A=>{A&&(S(A),u("home")),r(!1),P.APPS.MAIL.address.set(A)})},[]),e("div",{className:"mail-container",children:a(O.Provider,{value:{Email:[M,S],View:[p,u],Mails:[w,N],SelectedMail:[o,v],ShowNewMail:[s,d],LoggedIn:[m,t],fetchAndSetMail:c},children:[e(ce,{initial:!1,mode:"wait",children:s&&e(de,{})}),L[p]]})})}export{O as MailContext,ve as default};
