import{r as c,a as l,j as s}from"./jsx-runtime-7cf68bf7.js";import{u as N,f as v,H as F,q as H,L as a,ah as w,o as K,a6 as V,C as R,Y as W,r as $,Z as j,b as T,N as q,aw as Y}from"./Phone-ec5c0d3e.js";function Z(){var k;const i=N(T.Settings),L=N(T.PhoneNumber),[f,M]=c.useState(!1),[E,A]=c.useState([]),[C,g]=c.useState(!1),[e,m]=c.useState(null),[O,o]=c.useState(0),[S,n]=c.useState(!1),[d,P]=c.useState(!1),[p,I]=c.useState(""),[b,U]=c.useState(""),[_,y]=c.useState([]);c.useEffect(()=>{const t=setTimeout(()=>I(b),500);return()=>clearTimeout(t)},[b]),c.useEffect(()=>{p.length>0&&v("MarketPlace",{action:"search",query:p}).then(t=>{t&&y(t)})},[p]),c.useEffect(()=>{v("MarketPlace",{action:"getPosts",page:0}).then(t=>{t&&t.length>0?A(t):n(!0)}),v("isAdmin").then(t=>M(t))},[]);const D=()=>{var u,r;if(!(e!=null&&e.title)||!(e!=null&&e.description)||!(e!=null&&e.price)||((u=e==null?void 0:e.attachments)==null?void 0:u.length)===0){let h;switch(!0){case!(e!=null&&e.title):h=a("APPS.MARKETPLACE.ERROR_POPUP.NO_TITLE");break;case!(e!=null&&e.description):h=a("APPS.MARKETPLACE.ERROR_POPUP.NO_DESCRIPTION");break;case!(e!=null&&e.price):h=a("APPS.MARKETPLACE.ERROR_POPUP.NO_PRICE");break;case((r=e==null?void 0:e.attachments)==null?void 0:r.length)===0:h=a("APPS.MARKETPLACE.ERROR_POPUP.NO_ATTACHMENTS")}R.PopUp.set({title:a("APPS.MARKETPLACE.ERROR_POPUP.TITLE"),description:h,buttons:[{title:a("APPS.MARKETPLACE.ERROR_POPUP.OK")}]});return}let t={...e,number:L};v("MarketPlace",{action:"sendPost",data:t}).then(h=>{h&&(A([{...t,id:h,timestamp:new Date().getTime()},...E]),g(!1))})},X=t=>{t&&R.PopUp.set({title:a("APPS.MARKETPLACE.DELETE_POPUP.TITLE"),description:a("APPS.MARKETPLACE.DELETE_POPUP.TEXT"),buttons:[{title:a("APPS.MARKETPLACE.DELETE_POPUP.CANCEL")},{title:a("APPS.MARKETPLACE.DELETE_POPUP.PROCEED"),color:"red",cb:()=>{v("MarketPlace",{action:"deletePost",id:t}).then(u=>{u&&A(E.filter(r=>r.id!==t))})}}]})},x=()=>{if(S||d)return;let t=document.querySelector("#last");if(!t)return;!W(t)&&(P(!0),v("MarketPlace",{action:"getPosts",page:O+1}).then(r=>{r&&r.length>0?(A([...E,...r]),P(!1),r.length<15&&n(!0)):n(!0)}),o(r=>r+1))};return F("marketPlace:newPost",t=>{i.airplaneMode||A([t,...E])}),c.useEffect(()=>{m(null)},[C]),l("div",{className:"marketplace-container",children:[s("div",{className:"marketplace-header",children:s(H,{theme:"dark",placeholder:a("APPS.MARKETPLACE.SEARCH"),onChange:t=>U(t.target.value)})}),s("div",{className:"add",onClick:()=>g(!0),children:s(w,{})}),s("div",{className:"marketplace-wrapper",children:s("div",{className:"posts",onScroll:x,children:(p.length>0?_:E).map((t,u)=>{let r=u===E.length-1?"last":"";return s(z,{post:t,last:r,deletePost:X,isAdmin:f},u)})})}),C&&l("div",{className:"new-post-container",children:[l("div",{className:"new-post-header",children:[s("div",{className:"cancel",onClick:()=>g(!1),children:a("APPS.MARKETPLACE.CANCEL")}),s("div",{className:"title",children:a("APPS.MARKETPLACE.NEW_POST")}),s("div",{})]}),l("div",{className:"new-post-body",children:[l("div",{className:"item",children:[s("div",{className:"title",children:a("APPS.MARKETPLACE.TITLE")}),s(K,{type:"text",placeholder:"Title",maxLength:50,onChange:t=>m({...e,title:t.target.value})})]}),l("div",{className:"item",children:[s("div",{className:"title",children:a("APPS.MARKETPLACE.DESCRIPTION")}),s(V,{type:"text",placeholder:"Your post",maxLength:250,rows:5,onChange:t=>m({...e,description:t.target.value})})]}),s("div",{className:"item",children:l("div",{className:"images",children:[(e==null?void 0:e.attachments)&&e.attachments.length>0&&e.attachments.map((t,u)=>s("div",{className:"image",style:{backgroundImage:`url(${t})`},onClick:()=>{m({...e,attachments:e.attachments.filter((r,h)=>h!==u)})}},u)),(!(e!=null&&e.attachments)||((k=e==null?void 0:e.attachments)==null?void 0:k.length)<=3)&&s("div",{className:"image",onClick:()=>{R.Gallery.set({onSelect:t=>m({...e,attachments:[...(e==null?void 0:e.attachments)??[],t.src]})})},children:s(w,{})})]})}),l("div",{className:"item",children:[s("div",{className:"title",children:a("APPS.MARKETPLACE.PRICE")}),s(K,{type:"number",placeholder:"0",onChange:t=>{if(!t.target.value.match(/^[0-9]*$/))return t.preventDefault();m({...e,price:parseFloat(t.target.value)})}})]}),s("div",{className:"button",onClick:()=>D(),children:a("APPS.MARKETPLACE.POST")})]})]})]})}const z=({post:i,last:L,deletePost:f,isAdmin:M})=>{const E=N(T.Settings),A=N(T.PhoneNumber),C=N(q),g=c.useRef(null),e=c.useRef(null),[m,O]=c.useState(0),o={pos:{startLeft:0,startX:0},onMouseDown:n=>{o.pos={startLeft:e.current.scrollLeft,startX:n.clientX},e.current.style.userSelect="none",document.addEventListener("mouseup",o.onMouseUp),document.addEventListener("mousemove",o.onMove)},onMove:n=>{const d=(n.clientX-o.pos.startX)/Y(E.display.size);e.current.scrollLeft=o.pos.startLeft-d;const P=e.current.getBoundingClientRect();(P.left-5>n.clientX||n.clientX>P.right-5)&&o.onMouseUp()},onMouseUp:()=>{e.current.style.removeProperty("user-select"),document.removeEventListener("mouseup",o.onMouseUp),document.removeEventListener("mousemove",o.onMove);const n=i.attachments,d=e.current.clientWidth;let P=m;const p=e.current.scrollLeft-o.pos.startLeft;p>d/2&&P<n.length-1?P++:p<-d/2&&P>0&&P--,S(P)}},S=n=>{e.current.scrollTo({left:n*e.current.offsetWidth,behavior:"smooth"}),O(n)};return l("div",{className:"post",id:L,ref:g,children:[s("div",{className:"images",ref:e,onMouseDown:o.onMouseDown,children:i.attachments&&i.attachments.map((n,d)=>s("div",{className:"image",children:s("img",{src:n,onClick:()=>R.FullscreenImage.set(n)})},d))}),l("div",{className:"post-info",children:[l("div",{className:"post-header",children:[s("div",{className:"price",children:C.CurrencyFormat.replace("%s",i.price)}),i.attachments&&i.attachments.length>1&&s("div",{className:"scroll-dots",children:i.attachments.map((n,d)=>s("div",{className:`dot ${m==d&&"active"}`,onClick:()=>S(d)},d))})]}),l("div",{className:"post-content",children:[l("div",{className:"title",children:[i.title,l("div",{className:"date",children:["â€¢ ",$(i.timestamp)]})]}),s("div",{className:"description",children:j(i.description)}),l("div",{className:"buttons",children:[A!==i.number&&s("div",{className:"button",onClick:()=>{window.postMessage({data:{number:i.number,popUp:!0},action:"phone:contact"})},children:a("APPS.MARKETPLACE.CONTACT")}),(M||i.number===A)&&s("div",{className:"button red",onClick:()=>f(i.id),children:a("APPS.MARKETPLACE.REMOVE")})]})]})]})]})};export{Z as default};
